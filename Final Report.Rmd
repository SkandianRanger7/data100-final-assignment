---
title: "Predicting University Graduation Outcomes: An Analysis of Institutional Type, Resources, and Tuition"
author: "Spencer Robinson, Thomas Sefton, and Paolo Spadano"
output: 
  bookdown::pdf_document2:
    toc: false
    number_sections: false
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggrepel)
library(xgboost)
library(recipes)
library(rsample)
library(tidymodels)
library(tictoc)
library(doParallel)
library(yardstick)
library(ranger)
library(patchwork)
library(knitr)
```

### Introduction

Graduation outcomes differ greatly between public and private universities.
National NCES data on six-year following graduation rates indicated that students at private four-year institutions graduate at slightly higher rates on average than those at public four-year colleges, a gap that other analyses attribute partly to differences in selectivity, resources, and student support services.
For example, federal statistics report six-year graduation rates in the high 65-69% range at private compared with to a low 60-65% range at public institutions, while Urban Institute work using state-level samples finds that some private colleges within a state exceed 90% completion versus many public campuses clustered closer to 50%.
Together, these patterns suggest that the same structural features that drive higher tuition at private universities may also be linked to stronger outcomes, even as considerable variation exists.
Sources: <https://nces.ed.gov/fastfacts/display.asp?id=40#> <https://www.bestcolleges.com/research/college-graduation-rates/>

Nationwide tallies of institutions show that public universities make up less than one-third of all colleges, while private nonprofit and for-profit institutions together account for the majority, meaning that most campuses are privately controlled even when public systems enroll more students.
States with especially large higher-education sectors such as; New York, California, Texas, and Pennsylvania, tends to possess both a high number of institutions that are private, combining a dense network of private colleges with a sizable public system.
As a result, plots relating the number of universities in each state to the proportion that are private often show an upward trend, with states that have more campuses overall also displaying a higher degree of privatization, though this relationship can vary and is not definitive evidence of a national rule.
Sources:<https://nces.ed.gov/fastfacts/display.asp?id=1122> <https://www.worldatlas.com/articles/which-state-has-the-most-colleges.html> <https://www.appily.com/colleges/state>

### Research Question

What differentiates graduation rates for public and private colleges in the US?
Additionally, can the type of college be judged without direct metrics like government funding or even tuition price?
In answering these questions we also aim to explore the quantifiable differences in education quality between public and private institutions.

### Tidying

The tidying process involved reading two datasets: one on faculty compensation (AAUP) and one on college demographics and admissions (US News).
Missing values (denoted by \*) were converted to "NA" in both datasets.
In the faculty compensation data, several columns representing averages and counts were multiplied by 100 to represent their real value.
The US News data was improved by converting the numeric public/private code into categorical labels.
Additionally, two new features were added by calculating the IQR for both SAT Math and SAT Verbal scores, which measures the spread of scores for admitted students.
The data was then reformatted in two ways: first to create a summary table by grouping institutions by their public/private status and calculating mean tuition, graduation rate, and SAT scores.
Second, to reshape the data from a wide format to a long format by consolidating all standardized test score variables (averages, Q1s, Q3s) into three descriptive columns (stat, test, and section) alongside a single score column.

```{r tidying}
aaup_url = "https://lib.stat.cmu.edu/datasets/colleges/aaup.data"
usnews_url = "https://lib.stat.cmu.edu/datasets/colleges/usnews.data"
aaup_cols = c("fed_id", "college_name", "state", "type", "avg_sal_full", "avg_sal_associate", "avg_sal_assistant", "avg_sal_all", "avg_comp_full", "avg_comp_associate", "avg_comp_assistant", "avg_comp_all", "num_full", "num_associate", "num_assistant", "num_instructor", "num_all")
usnews_cols = c("fed_id","college_name","state","public_private","avg_sat_math","avg_sat_verbal","avg_sat_combined","avg_act","q1_sat_math","q3_sat_math","q1_sat_verbal","q3_sat_verbal","q1_act","q3_act","num_apps_received","num_apps_accepted","num_new_enrolled","pct_top10_hs","pct_top25_hs","num_ft_undergrads","num_pt_undergrads","tuition_instate","tuition_outstate","room_board_cost","room_cost","board_cost","fees_additional","books_estimated","personal_spending_est","pct_faculty_phd","pct_faculty_terminal","student_faculty_ratio","pct_alumni_donate","instr_exp_per_student","grad_rate")
calc_iqr = function(q1, q3) q3-q1
aaup = read.csv(aaup_url, header = FALSE, col.names = aaup_cols, na.strings = "*") |>
  mutate(across(starts_with(c("avg", "num")), ~ .x * 100))
usnews = read.csv(usnews_url, header = FALSE, col.names = usnews_cols, na.strings = "*") |>
  mutate(public_private = factor(public_private, levels = c(1, 2), labels = c("public", "private"))) |>
  mutate(sat_math_iqr = calc_iqr(q1_sat_math, q3_sat_math), sat_verbal_iqr = calc_iqr(q1_sat_verbal, q3_sat_verbal))
train_val_split <- initial_split(usnews, prop = 0.8, strata = public_private)
uni_train_val <- training(train_val_split)
uni_test <- testing(train_val_split) # 20% for final evaluation
train_val_split_2 <- initial_split(uni_train_val, prop = 0.75, strata = public_private)
uni_train <- training(train_val_split_2) # 60% for training
uni_val <- testing(train_val_split_2) # 20% for validation
usnews <- uni_train # Ensures only training data is used for plots
pub_vs_priv = usnews |> group_by(public_private) |>
  summarize(avg_tuition = mean(tuition_instate, na.rm = TRUE), avg_grad_rate = mean(grad_rate, na.rm = TRUE), avg_sat = mean(avg_sat_combined, na.rm = TRUE))
sat_long <- usnews |> pivot_longer(
    cols = matches("^(avg|q1|q3)_(sat|act)"),
    names_to = c("stat", "test", "section"),
    names_pattern = "^(avg|q1|q3)_(sat|act)_?(math|verbal)?$",
    values_to = "score") |>
  select(fed_id, college_name, state, stat, test, section, score)
```

### Exploratory Plots

```{r, fig.height=4}
iqr_long <- usnews |> select(public_private, sat_math_iqr, sat_verbal_iqr) |>
  pivot_longer(cols = ends_with("iqr"), names_to = "SAT_Section_IQR", values_to = "IQR_Value") |>
  mutate(SAT_Section_IQR = str_remove(SAT_Section_IQR, "sat_"),
         SAT_Section_IQR = str_replace(SAT_Section_IQR, "_iqr", ""))
ggplot(iqr_long, aes(x = public_private, y = IQR_Value, fill = SAT_Section_IQR)) +
  geom_boxplot() + facet_wrap(~ SAT_Section_IQR) + labs(
    title = "Interquartile Range (IQR) of SAT Scores by Institution Type",
    x = "Institution Type",y = "Score IQR (Q3 - Q1)",fill = "SAT Section") + theme_bw()
```
Across both tests the IQR is quite similar between public and private institutions.
However, the math spread is slightly wider.
Private schools tend to have more upward outliers suggesting that they catch many of the highest achieving students.
```{r plots, fig.height=3}
usnews |> select(public_private, tuition_instate, tuition_outstate) |>
  pivot_longer(cols = c(tuition_instate, tuition_outstate), names_to = "instate_outstate", values_to = "tuition") |>
  ggplot() +
    geom_violin(aes(x = public_private, y = tuition, fill = instate_outstate, colour = instate_outstate)) +
  labs(title = "Distribution of In-State vs Out-of-State Tuition",
    subtitle = "Tuition Levels Differ Substantially Between Public and Private Institutions",
    x = "Institution Type",y = "Tuition Cost (USD)",fill = "Tuition Type",
    caption = "Private schools charge far higher tuition but discrimate less by location") + 
  theme_bw()
```
Public universities offer significantly lower in-state tuition due to state subsidies, while out of state students face generally higher charges.
Private universities do not differentiate based on residency status, display substantially higher tuition overall with greater variation.
This pattern aligns with national tuition statistic from the U.S.
Private universities do not differentiate based on residency status, display substantially higher tuition overall with greater variation.
This pattern aligns with national tuition statistic from the U.S.
Department of Education, which shows that private institutions charge substantially higher tuition and that out-of-state students at public universities pay considerably higher than in-state students.
Source: <https://nces.ed.gov/programs/digest/d23/tables/dt23_330.10.asp>

```{r, fig.height=4}
aaup_salary_long <- aaup |> mutate(type = factor(type)) |>
  select(type, starts_with("avg_sal_")) |> pivot_longer(cols = starts_with("avg_sal_"),
    names_to = "rank",names_pattern = "avg_sal_(.*)",values_to = "avg_salary") |>
  mutate(rank = factor(rank,levels = c("assistant", "associate", "full", "all"), 
      labels = c("Assistant", "Associate", "Full", "All ranks")))
salary_summary <- aaup_salary_long |> group_by(type, rank) |>
  summarise(mean_salary = mean(avg_salary, na.rm = TRUE) / 100,.groups = "drop")
ggplot(salary_summary) +
  geom_col(aes(x = rank, y = mean_salary, fill = rank)) + facet_wrap(~type) +
  labs(title = "Average Faculty Salary by Rank and Institution Type",
    subtitle = "Faculty at Private Universities Tend to Earn More at Every Rank",
    x = "Faculty Rank", y = "Average Salary (USD)",
    caption = "Across AAUP institution types, average faculty salaries consistently rise with rank.") + 
  theme_bw()
```

These plots compare faculty salaries across AAUP institutional categories (I, IA, IIB, VIIB), showing that salaries consistently decline as institutions move from doctoral-granting to two-year colleges.
Faculty at Type I institutions earn the highest salaries across all ranks.
This aligns with AAUP's institutional classification system, which defines Type I institutions as research-intensive universities and Type IIB/VIIB institutions as primarily undergraduate with fewer graduate programs and lower average compensation.
Source: <https://www.aaup.org/explanation-statistical-data-5>

### Modelling Plots

```{r, fig.height=3}
usnews |> mutate(state = fct_lump(state, 4)) |>
  ggplot() +
  geom_boxplot(aes(x = reorder(state, grad_rate, FUN=median), y = grad_rate, fill = state)) +
  facet_wrap(~public_private) + labs(
    title = "Graduation Rates Across States and Institution Types",
    subtitle = "States Grouped into the Most Frequent Categories - Remaining States Grouped as 'Other'",
    x = "State",y = "Graduation Rate (%)",fill = "State",
    caption = "Private universities generally show higher median graduation rates than public across states.") +
  theme_bw()
```

Private institutions consistently show higher median graduation rates than public universities within the same states, reflecting differences in selectivity, student support, and available resources.
Findings from Urban Institute also show that private four-year colleges report substantially higher graduation rates than public four-year colleges withing the same state.
Source: <https://www.urban.org/sites/default/files/publication/101635/comparing_colleges_graduation_rates_0.pdf>

```{r, fig.height=3}
usnews |> select(public_private, grad_rate, tuition_instate, tuition_outstate) |>
  pivot_longer(cols = c(tuition_instate, tuition_outstate), names_to = "tuition_type",
    values_to = "tuition") |> ggplot(aes(x = tuition, y = grad_rate, color = public_private)) +
  geom_point(alpha = 0.6) + geom_smooth(method = "lm", se = FALSE, linewidth = 1) +
  facet_wrap(~ tuition_type, scales = "free_x") +
  labs(title = "Graduation Rate vs. Tuition Cost by Institution Type",
    subtitle = "Comparing In-State and Out-of-State Tuition Levels",
    x = "Tuition Cost (USD)", y = "Graduation Rate (%)", color = "Institution Type",
    caption = "Private schools generally charge more tuition but show a wider range of graduation outcomes.") +
  theme_bw()
```

The above scatter plot shows that despite private schools almost always charging higher tuition, graduation outcomes are still mixed.
This indicates that public or private status alone is a weak indicator of graduation rate, but are still important to consider since graduation rates only reach their true peaks at private schools.

### Linear Modelling

```{r modelling, fig.height=3.5}
lm_spec <- linear_reg() |> set_engine("lm")
formulas_to_test <- list(
  Grad_Exp_Full = grad_rate ~ instr_exp_per_student * public_private,
  Grad_Exp_No_Int = grad_rate ~ instr_exp_per_student + public_private,
  Grad_Exp_No_Cont = grad_rate ~ public_private,
  Grad_Ratio_Full = grad_rate ~ student_faculty_ratio * public_private,
  Grad_Ratio_No_Int = grad_rate ~ student_faculty_ratio + public_private,
  Grad_Ratio_No_Cont = grad_rate ~ public_private)
calculate_rmse <- function(fit, data) {
  preds <- predict(fit, new_data = data) |> 
    bind_cols(data |> select(grad_rate))
  rmse_value <- preds |> rmse(truth = grad_rate, estimate = .pred) |>
    select(.estimate) |> pull()
  return(rmse_value)}
fit_and_validate <- function(formula, spec, data) {
  wf <- workflow() |> add_model(spec) |> add_formula(formula)
  fit <- wf |> fit(data = data)
  list(fit = fit, rmse = calculate_rmse(fit, uni_val))}
model_results <- map(formulas_to_test, ~fit_and_validate(.x, lm_spec, uni_train))
grad_exp_fit_full <- model_results$Grad_Exp_Full$fit
grad_ratio_fit_full <- model_results$Grad_Ratio_Full$fit
rmse_comparison_table <- tibble(
  Model = names(model_results),
  RMSE_Validation = map_dbl(model_results, "rmse")) |> mutate(
    Model_Family = if_else(str_detect(Model, "Exp"), "Model 1: Expense", "Model 2: Ratio"),
    Model_Type = case_when(
      str_detect(Model, "Full") ~ "Full Model",
      str_detect(Model, "No_Cont") ~ "No Continuous Feature",
      str_detect(Model, "No_Int") ~ "No Interaction Term", .default = "Error"))
kable(rmse_comparison_table) 
ggplot(rmse_comparison_table) +
  geom_col(aes(x = Model, y = RMSE_Validation, fill = Model_Family), show.legend = FALSE) +
  geom_text(aes(x = Model, y = RMSE_Validation, label = round(RMSE_Validation, 2)), 
            vjust = 1) +
  facet_wrap(~ Model_Family, scales = "free_x") + labs(
    title = "Validation RMSE Comparison Across Linear Model Variations",
    subtitle = "RMSE calculated on the held-out validation set",
    x = "Model Specification",y = "Validation RMSE (Graduation Rate % Error)") +
  theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Two sets of features were used to project the graduation rate: the student to faculty ratio and the instructional expenditure per student.
Both of these features were combined with the private/public classification.
These two metrics were chosen because they represent the amount of support given to the studend and thus the advantage the school provides to students who might otherwise struggle to graduate.

### Advanced Modelling

```{r advanced_modelling, results = 'hide'}
xgb_tune_spec <- boost_tree(trees = tune(),tree_depth = tune(),mtry = tune(),
  min_n = tune(),learn_rate = 0.1,) |> set_engine("xgboost") |>
  set_mode("classification")
xgb_params <- parameters(trees(range = c(500, 2000)), tree_depth(range = c(3, 10)),
  mtry(range = c(3, 30)), min_n(range = c(3, 40)))
rf_tune_spec <- rand_forest(trees = 1000,mtry = tune(),min_n = tune()) |>
  set_engine("ranger") |> set_mode("classification")
rf_params <- parameters(mtry(range = c(3, 30)), min_n(range = c(3, 40)))
uni_folds <- vfold_cv(uni_train, v = 2, strata = public_private)
cl <- makePSOCKcluster(detectCores() - 4)
registerDoParallel(cl)
print("Parallel processing enabled")
full_recipe <- recipe(public_private ~ ., data = uni_train) |>
  update_role(
    c(fed_id, college_name), 
    new_role = "ID") |>
  step_novel(state) |>
  step_dummy(all_nominal_predictors(), one_hot = TRUE) |>
  step_impute_median(all_numeric_predictors()) |>
  step_normalize(all_numeric_predictors())
costless_recipe <- recipe(public_private ~ ., data = uni_train) |>
  update_role(
    c(fed_id, college_name, tuition_instate, tuition_outstate, room_board_cost, room_cost, board_cost, fees_additional, books_estimated, personal_spending_est, instr_exp_per_student), 
    new_role = "ID") |>
  step_novel(state) |>
  step_dummy(all_nominal_predictors(), one_hot = TRUE) |>
  step_impute_median(all_numeric_predictors()) |>
  step_normalize(all_numeric_predictors())
workflows <- workflow_set(preproc = list(full = full_recipe, costless = costless_recipe), 
                             models = list(xgb = xgb_tune_spec, rf = rf_tune_spec))
tic()
bayes_results = list()
map(workflows$wflow_id, function(id) {
  current_workflow <- workflows |>
        extract_workflow(id = id)
  current_metrics = metric_set(roc_auc, accuracy)
  if (str_detect(id, "rf")) {current_params <- rf_params} else {
    current_params <- xgb_params}
  bayes_results[[id]] <<- tune_bayes(current_workflow,resamples = uni_folds,
    iter = 5,param_info = current_params,metrics = current_metrics,
    control = control_bayes(no_improve = 10,save_pred = TRUE,verbose = TRUE))})
stopCluster(cl)
toc()
final_fits = list()
best_params = list()
for (mod_name in names(bayes_results)){
  current_best_params <- select_best(bayes_results[[mod_name]], metric = "roc_auc")
  best_params[[mod_name]] = current_best_params
  final_workflow <- workflows |> extract_workflow(id = mod_name) |>
    finalize_workflow(current_best_params)
  final_fits[[mod_name]] <- final_workflow |> fit(data = uni_train)}
```

```{r, fig.height=2}
final_results <- map_dfr(
  final_fits, .f = function(model_fit) {
    test_predictions <- predict(model_fit, new_data = uni_test, type = "prob") |>
     bind_cols(uni_test |> select(public_private))
    class_predictions <- predict(model_fit, new_data = uni_test, type = "class")
    test_predictions <- test_predictions |>
      bind_cols(class_predictions)
    roc_auc_result <- test_predictions |>
      roc_auc(truth = public_private,.pred_public)
    accuracy_result <- test_predictions |>
      accuracy(truth = public_private,estimate = .pred_class )
    bind_rows(roc_auc_result, accuracy_result)},.id = "model_name" )
final_results <- final_results |> 
  pivot_wider(names_from = .metric, values_from = .estimate) |>
  separate_wider_delim(model_name, "_", names = c("recipe", "model"))
kable(final_results)
ggplot(final_results) + geom_col(aes(x=model, y=accuracy, fill=model)) + facet_wrap(~recipe)
```

This more advanced XGBoost model relates to the second goal of the study, attempting to predict whether a school is public or private.
Since it is a classification model, it cannot be compared to a linear one.
Instead, it is compared to a random forest model that can manage the same metric.
Two sets of features were modelled: all available in the dataset and all but costs.
The intention behind this was to see if schools could still be accurately classified when ignoring the most glaring difference in tuition price.
Although some accuracy was lost, about 90% were still classified correctly without costs.

### Conclusions and Limitations

The analysis provides strong evidence that a college's financial and academic resources are quantifiable differentiators of graduation outcomes.
Models utilizing both instructional expenditure per student and the student-faculty ratio were successful, indicating that investment in student support and faculty accessibility plays a key role.
Ultimately, the best predictive models move beyond basic tuition and institution type to capture the differences in resource allocation that directly affect student success.

While the exploratory linear and advanced models identified key predictors that differentiate graduation rates for colleges, the analysis faces significant limitations due to the age of the data.
All institutional and admissions data are from a period shortly before the year 2000, which means the findings may not accurately reflect the current landscape of U.S. higher education.

Furthermore, the linear models are limited in their ability to capture non-linear relationships or complex interactions among features like test scores and enrollment demographics.
While the advanced models (XGBoost/Random Forest) mitigate this by modeling non-linearity, they operate as "black boxes," which makes drawing intuitive conclusions about the specific mechanisms driving graduation rates more challenging compared to interpreting the coefficients of a linear regression.
